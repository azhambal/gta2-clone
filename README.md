# GTA 2 Clone

Браузерный клон классической игры Grand Theft Auto 2, созданный с использованием современных веб-технологий. Проект воспроизводит ключевые механики оригинала: изометрический вид сверху, многоуровневую карту, реалистичную физику транспорта, открытый мир с AI-трафиком и пешеходами, систему миссий и wanted-уровень.

## О проекте

GTA 2 Clone — это амбициозный проект по созданию полнофункционального браузерного клона GTA 2. Игра разрабатывается с нуля, используя современный технологический стек и лучшие практики разработки игр.

### Ключевые особенности

- **2.5D изометрический вид сверху** — классическая проекция GTA 2 с параллельной проекцией под углом ~30°
- **Многоуровневая карта** — 3D-сетка блоков 256×256×8 уровней с мостами, туннелями и эстакадами
- **Реалистичная физика транспорта** — аркадная модель с дрифтом, разными типами машин и поверхностей
- **Открытый мир** — живой город с AI-трафиком, пешеходами и динамическими событиями
- **Система миссий** — сюжетные и побочные задания
- **Wanted-система** — 6 уровней розыска с различными типами преследователей
- **Богатый геймплей** — вождение, стрельба, взрывы, взаимодействие с миром

## Технологический стек

### Основные технологии

| Категория | Технология | Назначение |
|-----------|------------|------------|
| **Язык** | TypeScript 5.x | Типизация, надёжность кода |
| **Сборка** | Vite 5.x | Быстрая сборка, HMR |
| **Рендеринг** | PixiJS 8.x | WebGL рендеринг спрайтов |
| **Физика** | Matter.js 0.19.x | 2D физика твёрдых тел |
| **Звук** | Howler.js 2.2.x | Кроссбраузерное аудио |
| **ECS** | bitECS 0.3.x | Entity Component System |

### Архитектурные решения

- **ECS-архитектура** — гибкая и производительная система сущностей через bitECS
- **Чанковая система** — оптимизация рендеринга и памяти через разбиение карты на чанки
- **Блочная карта** — многоуровневая карта из блоков 64×64×64 единиц
- **Slopes система** — наклонные блоки для плавных переходов между уровнями
- **Spatial Hash** — быстрый поиск сущностей в области
- **Hierarchical FSM** — система искусственного интеллекта

## Архитектура проекта

### Основные подсистемы

#### Engine (Ядро движка)
Центральный класс, управляющий жизненным циклом игры:
- Инициализация всех подсистем
- Главный игровой цикл (Game Loop)
- Управление временем и delta time
- Координация между подсистемами

#### World (Игровой мир)
Контейнер для карты и всех игровых сущностей:
- Хранение и управление картой (GameMap)
- Регистрация и удаление сущностей
- Пространственное индексирование (Spatial Hash)
- Запросы к миру (raycast, overlap)

#### Renderer (Система рендеринга)
Отвечает за визуальное отображение игры:
- Управление PixiJS Application
- Рендеринг блоков карты
- Рендеринг спрайтов сущностей
- Сортировка по глубине (Z-order)
- Culling невидимых объектов
- Эффекты (тени, освещение, частицы)

#### EntitySystem (Система сущностей)
ECS-архитектура для игровых объектов:
- Создание и уничтожение сущностей
- Управление компонентами
- Выполнение систем (Systems)
- Запросы сущностей по компонентам

#### Physics (Физический движок)
Симуляция физики игрового мира:
- Физика транспортных средств
- Обнаружение коллизий
- Обработка столкновений
- Синхронизация с игровым миром

#### AI (Искусственный интеллект)
Умное поведение NPC:
- AI пешеходов (FSM)
- AI трафика
- AI полиции
- Поиск пути (A*)

#### Audio (Аудио система)
Звуковое сопровождение:
- Позиционный звук
- Музыка и радио
- Звуковые эффекты
- Ambient звуки по зонам

## Игровой мир

### Система координат

- **X, Y** — горизонтальная плоскость (север-юг, восток-запад)
- **Z** — вертикальная ось (высота/уровень)
- **1 блок** = 64×64×64 игровых единиц
- **1 игровая единица** ≈ 1 пиксель на экране (при масштабе 1:1)

### Структура карты

Карта разбита на:
- **256×256 блоков** по горизонтали
- **8 уровней** по вертикали (Z)
- **Чанки 16×16×8 блоков** для оптимизации
- **Всего 256 чанков** (16×16)

### Типы блоков

- **Базовые**: Air, Solid
- **Дороги**: Road, Sidewalk, Crosswalk
- **Наклоны**: SlopeN, SlopeS, SlopeE, SlopeW (переходы между уровнями)
- **Диагонали**: DiagonalNE, DiagonalNW, DiagonalSE, DiagonalSW
- **Жидкости**: Water, DeepWater
- **Особые**: Oil, Ice, Mud, Spikes (модификаторы движения)
- **Здания**: Wall, Window, Door
- **Объекты**: Fence, Barrier, Ramp

### Зоны и районы

Карта разделена на районы (Districts):
- **Downtown** — центр города с магазинами и полицией
- **Industrial** — промышленная зона с фабриками
- **Suburbs** — жилые районы с домами и парками

Каждый район имеет:
- Контролирующую банду
- Плотность трафика и пешеходов
- Типы спавнящихся машин
- Музыкальную тему
- Уровень полицейского присутствия

## Система сущностей (ECS)

Проект использует архитектуру Entity Component System (ECS) через библиотеку bitECS для максимальной производительности и гибкости.

### Компоненты

**Базовые компоненты:**
- `Position` — позиция в мире (x, y, z)
- `Velocity` — скорость движения (vx, vy, vz)
- `Rotation` — угол поворота
- `Sprite` — визуальное представление
- `Collider` — коллайдер для физики
- `Health` — здоровье

**Компоненты транспорта:**
- `Vehicle` — тип и состояние машины
- `VehiclePhysics` — физические параметры
- `VehicleDriver` — водитель и пассажиры
- `VehicleAI` — AI поведение

**Компоненты персонажей:**
- `Pedestrian` — тип пешехода
- `PedestrianAI` — AI состояние
- `Inventory` — инвентарь и оружие
- `PlayerControlled` — флаг игрока

### Системы

Системы выполняются в определённом порядке:
1. **Input Systems** — обработка ввода
2. **AI Systems** — искусственный интеллект
3. **Gameplay Systems** — оружие, взрывы
4. **Physics Systems** — физика и движение
5. **State Systems** — здоровье, смерть, спавн
6. **Animation Systems** — анимация спрайтов
7. **Render Systems** — отрисовка

## Физика

### Физика транспорта

Реалистичная аркадная модель движения машин:
- **Ускорение и торможение** — зависит от типа машины
- **Поворот** — с учётом скорости и сцепления
- **Дрифт** — при высокой скорости поворота
- **Разные типы машин**: Sports Car, Truck, Taxi, Police, Bus, Motorcycle

### Типы поверхностей

Разные поверхности влияют на движение:
- **Road** — нормальное движение
- **Grass** — замедление
- **Dirt** — пыль, небольшое замедление
- **Ice** — скольжение
- **Oil** — потеря контроля
- **Water** — сильное замедление, урон
- **Sand** — тяжёлое движение

### Коллизии

Система слоёв коллизий:
- **STATIC** — стены, здания
- **VEHICLE** — машины
- **PEDESTRIAN** — пешеходы
- **PROJECTILE** — пули, снаряды
- **PICKUP** — предметы
- **TRIGGER** — триггеры миссий

## Искусственный интеллект

### AI пешеходов

Пешеходы используют конечный автомат (FSM):
- **IDLE** — бездействие
- **WALKING** — движение к цели
- **FLEEING** — побег от опасности
- **DEAD** — смерть

Поведение:
- Патрулирование между точками
- Реакция на опасность (взрывы, выстрелы)
- Вход в машины
- Агрессия (для банд)

### AI трафика

Умное дорожное движение:
- Следование по полосам
- Остановка на светофорах
- Уступание при поворотах
- Объезд препятствий
- Реакция на аварии

### AI полиции

Система преследования с 6 уровнями розыска:
- **Level 1** — патрульные ищут игрока
- **Level 2** — патрульные преследуют
- **Level 3** — добавляются машины без сирен
- **Level 4** — добавляется SWAT
- **Level 5** — добавляется FBI
- **Level 6** — армия (танки, вертолёты)

Поведение:
- Pathfinding к последней известной позиции
- Предсказание движения игрока
- Координация между юнитами
- Блокирование путей отхода

### Поиск пути

- **Для пешеходов**: Grid-based A*
- **Для машин**: Waypoint Graph
- Оптимизации: Hierarchical A*, кэширование путей

## Рендеринг

### Система рендеринга

Используется PixiJS для эффективного WebGL рендеринга:
- **Texture Atlases** — упаковка всех текстур
- **Sprite Batching** — минимизация draw calls
- **Frustum Culling** — отсечение невидимых объектов
- **Z-Sorting** — правильная сортировка по глубине
- **Static Geometry Caching** — кэширование статичной геометрии

### Порядок отрисовки

1. **Background Layer** — фон
2. **Map Layers** — блоки карты по уровням Z
3. **Entity Layer** — сущности (отсортированные по глубине)
4. **Effects Layer** — частицы, взрывы
5. **UI Layer** — HUD, меню
6. **Minimap Layer** — миникарта

### Спрайты

- **Транспорт**: 32 угла поворота (каждые 11.25°), состояния повреждения
- **Персонажи**: 8 направлений, анимации (idle, walk, run, attack, death)
- **Эффекты**: частицы, взрывы, вспышки

## Аудио система

### Категории звуков

- **Sound Effects (SFX)**:
  - Оружие (выстрелы, перезарядка)
  - Транспорт (двигатель, скрип, гудок)
  - Удары и взрывы
  - Шаги по разным поверхностям
  - UI звуки

- **Музыка**:
  - Radio System (как в GTA) с несколькими радиостанциями
  - Переключение при смене станции
  - Fade при выходе из машины

- **Ambient**:
  - Зональные ambient звуки
  - Downtown: трафик, толпы, сирены
  - Industrial: машины, гудки
  - Suburbs: птицы, собаки

### Позиционный звук

- Затухание с расстоянием
- Стерео панорама (лево-право)
- Эффект Допплера для движущихся объектов

## Структура проекта

```
gta2-clone/
├── docs/                          # Документация
│   ├── gta2-clone-architecture.md # Подробная архитектура
│   └── implementation-plan/       # Пошаговый план разработки
├── src/
│   ├── main.ts                    # Точка входа
│   ├── Game.ts                    # Главный класс игры
│   ├── core/                      # Ядро движка
│   ├── world/                     # Игровой мир
│   ├── ecs/                       # Entity Component System
│   ├── rendering/                 # Рендеринг
│   ├── physics/                   # Физика
│   ├── input/                     # Ввод
│   ├── ai/                        # Искусственный интеллект
│   ├── audio/                     # Аудио
│   ├── assets/                    # Загрузка ресурсов
│   ├── gameplay/                  # Игровая логика
│   ├── ui/                        # Интерфейс
│   ├── scenes/                    # Сцены
│   └── utils/                     # Утилиты
└── assets/                        # Ресурсы игры
    ├── textures/                  # Текстуры
    ├── audio/                     # Звуки
    ├── maps/                      # Карты
    └── data/                      # Данные (конфиги)
```

## План разработки

Проект разбит на этапы с чёткими milestone'ами:

### Phase 1: Foundation (4-6 недель)
- Настройка проекта (Vite, TypeScript)
- Базовый движок и game loop
- Загрузка и рендеринг блочной карты
- Камера с прокруткой
- Базовый input handling
- Простой спрайт игрока

### Phase 2: Core Mechanics (6-8 недель)
- ECS архитектура (bitECS)
- Физика транспорта (Matter.js)
- Коллизии с картой
- Вход/выход из машины
- Многоуровневость (slopes, bridges)
- Базовые звуки

### Phase 3: AI & World (6-8 недель)
- AI пешеходов (FSM)
- AI трафика
- Система районов
- Спавн/деспавн сущностей
- Pathfinding (A*)
- Позиционный звук

### Phase 4: Combat & Police (4-6 недель)
- Система оружия
- Здоровье и урон
- AI полиции
- Wanted level
- Взрывы и частицы
- Разрушаемость

### Phase 5: Polish (4-6 недель)
- UI и HUD
- Minimap
- Меню и настройки
- Сохранение/загрузка
- Оптимизация
- Баги и полировка

### Phase 6: Content (ongoing)
- Создание карт
- Разнообразие машин
- Система миссий
- Дополнительный контент

## Оптимизации

### Рендеринг
- Frustum Culling — отсечение невидимых чанков
- Texture Batching — минимизация draw calls
- Static Geometry Caching — кэширование статичной геометрии
- LOD (Level of Detail) — упрощённые спрайты для дальних объектов
- Occlusion — не рисовать скрытые грани

### Физика и AI
- Spatial Partitioning — Spatial Hash для broad phase
- AI Distribution — распределение AI updates по кадрам
- Hierarchical A* — оптимизированный поиск пути
- Object Pooling — переиспользование объектов
- Fixed Timestep — фиксированный шаг для физики

### Память
- Streaming — загрузка только видимых чанков
- Reference Counting — управление ресурсами
- TypedArrays — эффективные структуры данных
- Garbage Collection — минимизация аллокаций

## Целевые платформы

- Современные браузеры (Chrome, Firefox, Safari, Edge)
- WebGL 2.0 для рендеринга
- Разрешение: 1920×1080 (адаптивное)
- Частота кадров: 60 FPS

## Документация

Подробная документация находится в директории `docs/`:
- `gta2-clone-architecture.md` — полное описание архитектуры проекта
- `implementation-plan/` — пошаговый план разработки с детальными инструкциями

## Лицензия

ISC
