# GTA 2 Clone — Архитектура игрового движка

## Оглавление

1. [Обзор проекта](#1-обзор-проекта)
2. [Технологический стек](#2-технологический-стек)
3. [Архитектура высокого уровня](#3-архитектура-высокого-уровня)
4. [Устройство игрового мира](#4-устройство-игрового-мира)
5. [Система рендеринга](#5-система-рендеринга)
6. [Система сущностей (ECS)](#6-система-сущностей-ecs)
7. [Физический движок](#7-физический-движок)
8. [Система ввода](#8-система-ввода)
9. [Искусственный интеллект](#9-искусственный-интеллект)
10. [Аудио система](#10-аудио-система)
11. [Управление ресурсами](#11-управление-ресурсами)
12. [Структура проекта](#12-структура-проекта)
13. [Форматы данных](#13-форматы-данных)
14. [Оптимизации](#14-оптимизации)
15. [План разработки](#15-план-разработки)

---

## 1. Обзор проекта

### 1.1 Цель

Создание браузерного клона GTA 2 с использованием современных веб-технологий. Игра должна воспроизводить ключевые механики оригинала:

- 2.5D изометрический вид сверху
- Многоуровневая карта с мостами, туннелями, эстакадами
- Реалистичная физика транспорта
- Открытый мир с AI-трафиком и пешеходами
- Система миссий и wanted-уровень

### 1.2 Ключевые особенности GTA 2

| Особенность | Описание |
|-------------|----------|
| **Проекция** | Параллельная проекция сверху под углом ~30° |
| **Карта** | 3D-сетка блоков 256×256×8 |
| **Блоки** | Кубы 64×64×64 единиц с 6 текстурированными гранями |
| **Спрайты** | 2D изображения с предрендеренными углами поворота |
| **Slopes** | Наклонные блоки для переходов между уровнями |
| **Физика** | Аркадная модель с дрифтом и разными поверхностями |

### 1.3 Целевые платформы

- Современные браузеры (Chrome, Firefox, Safari, Edge)
- WebGL 2.0 для рендеринга
- Разрешение: 1920×1080 (адаптивное)
- Частота кадров: 60 FPS

---

## 2. Технологический стек

### 2.1 Основные технологии

| Категория | Технология | Версия | Назначение |
|-----------|------------|--------|------------|
| **Язык** | TypeScript | 5.x | Типизация, надёжность кода |
| **Сборка** | Vite | 5.x | Быстрая сборка, HMR |
| **Рендеринг** | PixiJS | 8.x | WebGL рендеринг спрайтов |
| **Физика** | Matter.js | 0.19.x | 2D физика твёрдых тел |
| **Звук** | Howler.js | 2.2.x | Кроссбраузерное аудио |
| **ECS** | bitECS | 0.3.x | Entity Component System |
| **Карты** | Tiled | 1.10.x | Редактор уровней |
| **UI** | Preact | 10.x | Игровой интерфейс |

### 2.2 Вспомогательные библиотеки

| Библиотека | Назначение |
|------------|------------|
| **gl-matrix** | Математика векторов и матриц |
| **pathfinding** | A* поиск пути для AI |
| **simplex-noise** | Процедурная генерация |
| **localforage** | Сохранение игры (IndexedDB) |
| **stats.js** | Отладочная информация FPS |
| **lil-gui** | Отладочная панель параметров |

### 2.3 Инструменты разработки

| Инструмент | Назначение |
|------------|------------|
| **Tiled Map Editor** | Создание и редактирование карт |
| **TexturePacker** | Упаковка спрайтов в атласы |
| **Aseprite** | Создание пиксельной графики |
| **Audacity** | Редактирование звуков |
| **ESLint + Prettier** | Линтинг и форматирование |
| **Vitest** | Юнит-тестирование |

---

## 3. Архитектура высокого уровня

### 3.1 Диаграмма архитектуры

```
┌─────────────────────────────────────────────────────────────────┐
│                         GAME APPLICATION                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   Engine    │  │    World    │  │   Scenes    │             │
│  │   (Core)    │◄─┤  (GameMap)  │◄─┤  (States)   │             │
│  └──────┬──────┘  └──────┬──────┘  └─────────────┘             │
│         │                │                                      │
│  ┌──────▼──────┐  ┌──────▼──────┐  ┌─────────────┐             │
│  │  Renderer   │  │   Entity    │  │   Physics   │             │
│  │  (PixiJS)   │  │   System    │  │ (Matter.js) │             │
│  └─────────────┘  │   (bitECS)  │  └─────────────┘             │
│                   └─────────────┘                               │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │    Input    │  │    Audio    │  │  Resources  │             │
│  │   Manager   │  │   (Howler)  │  │   (Assets)  │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
├─────────────────────────────────────────────────────────────────┤
│                     BROWSER / WebGL / WebAudio                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Основные подсистемы

#### Engine (Ядро движка)

Центральный класс, управляющий жизненным циклом игры.

**Ответственность:**
- Инициализация всех подсистем
- Главный игровой цикл (Game Loop)
- Управление временем и delta time
- Координация между подсистемами
- Обработка пауз и состояний

**Связи:**
- Владеет экземплярами всех менеджеров
- Вызывает update() и render() каждый кадр
- Передаёт delta time во все системы

#### World (Игровой мир)

Контейнер для карты и всех игровых сущностей.

**Ответственность:**
- Хранение и управление картой (GameMap)
- Регистрация и удаление сущностей
- Пространственное индексирование (Spatial Hash)
- Запросы к миру (raycast, overlap)

#### Renderer (Система рендеринга)

Отвечает за визуальное отображение игры.

**Ответственность:**
- Управление PixiJS Application
- Рендеринг блоков карты
- Рендеринг спрайтов сущностей
- Сортировка по глубине (Z-order)
- Culling невидимых объектов
- Эффекты (тени, освещение, частицы)

#### EntitySystem (Система сущностей)

ECS-архитектура для игровых объектов.

**Ответственность:**
- Создание и уничтожение сущностей
- Управление компонентами
- Выполнение систем (Systems)
- Запросы сущностей по компонентам

#### Physics (Физический движок)

Симуляция физики игрового мира.

**Ответственность:**
- Физика транспортных средств
- Обнаружение коллизий
- Обработка столкновений
- Синхронизация с игровым миром

### 3.3 Игровой цикл

```
┌─────────────────────────────────────────────────────────┐
│                    GAME LOOP (60 FPS)                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   1. INPUT PHASE                                        │
│      └─► InputManager.poll()                            │
│          - Считывание клавиатуры, мыши, геймпада        │
│          - Формирование команд игрока                   │
│                                                         │
│   2. UPDATE PHASE (Fixed Timestep: 1/60 sec)            │
│      ├─► Physics.step()                                 │
│      │   - Симуляция физики                             │
│      │   - Обнаружение коллизий                         │
│      │                                                  │
│      ├─► EntitySystem.update()                          │
│      │   - MovementSystem                               │
│      │   - VehicleSystem                                │
│      │   - AISystem                                     │
│      │   - AnimationSystem                              │
│      │   - WeaponSystem                                 │
│      │   - HealthSystem                                 │
│      │                                                  │
│      ├─► World.update()                                 │
│      │   - Обновление состояния мира                    │
│      │   - Спавн/деспавн сущностей                      │
│      │                                                  │
│      └─► Camera.update()                                │
│          - Следование за игроком                        │
│          - Интерполяция движения                        │
│                                                         │
│   3. RENDER PHASE (Variable Timestep)                   │
│      ├─► Renderer.beginFrame()                          │
│      │                                                  │
│      ├─► MapRenderer.render()                           │
│      │   - Culling видимых чанков                       │
│      │   - Отрисовка блоков по слоям                    │
│      │                                                  │
│      ├─► EntityRenderer.render()                        │
│      │   - Сортировка спрайтов по глубине               │
│      │   - Отрисовка всех сущностей                     │
│      │                                                  │
│      ├─► EffectsRenderer.render()                       │
│      │   - Частицы, тени, освещение                     │
│      │                                                  │
│      ├─► UIRenderer.render()                            │
│      │   - HUD, меню, миникарта                         │
│      │                                                  │
│      └─► Renderer.endFrame()                            │
│          - Отправка команд в GPU                        │
│                                                         │
│   4. AUDIO PHASE                                        │
│      └─► AudioManager.update()                          │
│          - Позиционный звук                             │
│          - Музыка, эффекты                              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 4. Устройство игрового мира

### 4.1 Система координат

```
                    Y- (Север)
                       ▲
                       │
                       │
         X- (Запад) ◄──┼──► X+ (Восток)
                       │
                       │
                       ▼
                    Y+ (Юг)

         Z+ ▲ (Вверх/Высота)
            │
            │
         Z- ▼ (Вниз)
```

**Единицы измерения:**
- 1 блок = 64×64×64 игровых единиц
- 1 игровая единица ≈ 1 пиксель на экране (при масштабе 1:1)
- Скорость измеряется в единицах/секунду

### 4.2 Структура карты

#### Иерархия карты

```
┌─────────────────────────────────────────────────────────┐
│                        GameMap                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │                    Chunks[][]                     │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │  │
│  │  │ Chunk   │ │ Chunk   │ │ Chunk   │ │ Chunk   │  │  │
│  │  │ (0,0)   │ │ (1,0)   │ │ (2,0)   │ │ (3,0)   │  │  │
│  │  │ 16×16×8 │ │ 16×16×8 │ │ 16×16×8 │ │ 16×16×8 │  │  │
│  │  │ blocks  │ │ blocks  │ │ blocks  │ │ blocks  │  │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘  │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │  │
│  │  │ Chunk   │ │ Chunk   │ │ Chunk   │ │ Chunk   │  │  │
│  │  │ (0,1)   │ │ (1,1)   │ │ (2,1)   │ │ (3,1)   │  │  │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘  │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  Размер карты: 256×256×8 блоков                         │
│  Размер чанка: 16×16×8 блоков                           │
│  Всего чанков: 16×16 = 256                              │
└─────────────────────────────────────────────────────────┘
```

#### Класс GameMap

**Ответственность:**
- Хранение всех чанков карты
- Загрузка/сохранение карты
- Глобальные запросы к блокам
- Управление зонами (districts)

**Основные методы:**
- `getBlock(x, y, z)` — получить блок по мировым координатам
- `setBlock(x, y, z, block)` — установить блок
- `getChunk(chunkX, chunkY)` — получить чанк
- `getGroundLevel(x, y)` — найти уровень земли в точке
- `raycast(origin, direction, maxDistance)` — трассировка луча
- `getBlocksInRadius(x, y, z, radius)` — блоки в радиусе

#### Класс Chunk

**Ответственность:**
- Хранение 3D-массива блоков (16×16×8)
- Локальные запросы к блокам
- Кэширование геометрии для рендеринга
- Dirty-флаг для перестроения меша

**Оптимизации:**
- Flat array вместо 3D массива для cache locality
- Статические чанки не обновляются
- Frustum culling на уровне чанков

### 4.3 Блоки (Blocks)

#### Анатомия блока

```
              ┌─────────────────┐
             /│    TOP (5)     /│
            / │               / │
           /  │              /  │
          ┌───┼─────────────┐   │
          │   │   NORTH(0)  │   │
          │   │             │   │
   WEST(3)│   └─────────────┼───┘ EAST(1)
          │  /              │  /
          │ /    SOUTH(2)   │ /
          │/                │/
          └─────────────────┘
                BOTTOM (4)
```

#### Структура данных блока

**BlockData (упакованные данные, 32 бита):**

```
┌────────────────────────────────────────────────────────┐
│  Bits 0-7   │  Block Type (256 типов)                  │
│  Bits 8-11  │  Slope Type (16 вариантов)               │
│  Bits 12-15 │  Rotation (16 углов × 22.5°)             │
│  Bits 16-19 │  Flags (solid, water, damage, etc.)      │
│  Bits 20-31 │  Reserved                                │
└────────────────────────────────────────────────────────┘
```

**BlockDefinition (полное описание типа):**
- Текстуры для всех 6 граней
- Тип коллизии (none, solid, slope, platform)
- Тип поверхности (road, grass, water, oil, etc.)
- Звук шагов/езды
- Флаги (прозрачность, разрушаемость, интерактивность)

#### Типы блоков

| Категория | Типы | Описание |
|-----------|------|----------|
| **Базовые** | Air, Solid | Пустота и твёрдый блок |
| **Дороги** | Road, Sidewalk, Crosswalk | Дорожное покрытие |
| **Наклоны** | SlopeN, SlopeS, SlopeE, SlopeW | Въезды на уровень выше |
| **Диагонали** | DiagonalNE, DiagonalNW, DiagonalSE, DiagonalSW | Срезанные углы |
| **Жидкости** | Water, DeepWater | Вода (урон/смерть) |
| **Особые** | Oil, Ice, Mud, Spikes | Модификаторы движения |
| **Здания** | Wall, Window, Door | Части зданий |
| **Объекты** | Fence, Barrier, Ramp | Дорожные объекты |

#### Slopes (Наклонные блоки)

Ключевая механика для многоуровневости:

```
SLOPE NORTH (въезд с юга на север):
                    ___________
                   /          /
                  /          /
                 /          /
                /──────────/
              Z+1         Z+0

SLOPE VARIANTS:
┌──────────────────────────────────────────────────┐
│  SlopeN      SlopeS      SlopeE      SlopeW     │
│    ╱│        │╲          ──╲         ╱──        │
│   ╱ │        │ ╲           ╲        ╱           │
│  ╱──┘        └──╲           ╲──    ──╱          │
│                                                  │
│  Steep variants (45°) vs Normal (26°)           │
└──────────────────────────────────────────────────┘
```

### 4.4 Зоны и районы (Districts)

#### Структура районов

```
┌─────────────────────────────────────────────────────────┐
│                      GAME MAP                           │
│  ┌─────────────┬─────────────┬─────────────┐           │
│  │   DOWNTOWN  │  INDUSTRIAL │   SUBURBS   │           │
│  │   (Gang A)  │   (Gang B)  │  (Gang C)   │           │
│  │             │             │             │           │
│  │  - Shops    │  - Factories│  - Houses   │           │
│  │  - Police   │  - Warehouses│ - Parks    │           │
│  │  - Traffic  │  - Trucks   │  - Families │           │
│  └─────────────┴─────────────┴─────────────┘           │
└─────────────────────────────────────────────────────────┘
```

#### Класс District

**Свойства:**
- Границы (полигон или AABB)
- Контролирующая банда
- Плотность трафика и пешеходов
- Типы спавнящихся машин
- Музыкальная тема
- Уровень полицейского присутствия

### 4.5 Пространственное индексирование

#### Spatial Hash Grid

Для быстрого поиска сущностей в области:

```
┌─────────────────────────────────────────────────────────┐
│              SPATIAL HASH (Cell Size: 128)              │
│  ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐     │
│  │     │     │  ●  │     │     │     │     │     │     │
│  ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤     │
│  │     │ ● ● │     │     │  ●  │     │     │     │     │
│  ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤     │
│  │  ●  │     │     │     │     │ ● ● │     │     │     │
│  ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤     │
│  │     │     │  ●  │     │     │     │  ●  │     │     │
│  └─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘     │
│                                                         │
│  Запрос: getNearby(x, y, radius)                        │
│  - Определить затронутые ячейки                         │
│  - Вернуть сущности из этих ячеек                       │
│  - Точная проверка расстояния                           │
└─────────────────────────────────────────────────────────┘
```

#### Класс SpatialHash

**Методы:**
- `insert(entity, bounds)` — добавить сущность
- `remove(entity)` — удалить сущность
- `update(entity, newBounds)` — обновить позицию
- `query(bounds)` — найти сущности в области
- `queryRadius(x, y, radius)` — найти в радиусе

---

## 5. Система рендеринга

### 5.1 Архитектура рендерера

```
┌─────────────────────────────────────────────────────────┐
│                    RenderManager                        │
│  ┌───────────────────────────────────────────────────┐  │
│  │                  PixiJS Application               │  │
│  │  ┌─────────────────────────────────────────────┐  │  │
│  │  │                   Stage                     │  │  │
│  │  │  ┌─────────────┐  ┌─────────────────────┐   │  │  │
│  │  │  │ Background  │  │    GameContainer    │   │  │  │
│  │  │  │   Layer     │  │  ┌───────────────┐  │   │  │  │
│  │  │  └─────────────┘  │  │  Map Layers   │  │   │  │  │
│  │  │                   │  │  (Z: 0-7)     │  │   │  │  │
│  │  │  ┌─────────────┐  │  ├───────────────┤  │   │  │  │
│  │  │  │   UI Layer  │  │  │  Entity Layer │  │   │  │  │
│  │  │  │   (HUD)     │  │  │  (Sorted)     │  │   │  │  │
│  │  │  └─────────────┘  │  ├───────────────┤  │   │  │  │
│  │  │                   │  │ Effects Layer │  │   │  │  │
│  │  │  ┌─────────────┐  │  │ (Particles)   │  │   │  │  │
│  │  │  │  Minimap    │  │  └───────────────┘  │   │  │  │
│  │  │  │   Layer     │  └─────────────────────┘   │  │  │
│  │  │  └─────────────┘                           │  │  │
│  │  └─────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 5.2 Рендеринг карты

#### Порядок отрисовки блоков

```
┌─────────────────────────────────────────────────────────┐
│              BLOCK RENDERING ORDER                      │
│                                                         │
│  Для каждого уровня Z (от 0 до 7):                      │
│    Для каждой строки Y (от дальней к ближней):          │
│      Для каждого столбца X (слева направо):             │
│        1. Отрисовать верхнюю грань (top)                │
│        2. Отрисовать переднюю грань (south)             │
│        3. Отрисовать правую грань (east)                │
│                                                         │
│  Painter's Algorithm: дальние объекты рисуются первыми  │
└─────────────────────────────────────────────────────────┘
```

#### Класс MapRenderer

**Ответственность:**
- Определение видимых чанков (Frustum Culling)
- Рендеринг блоков в правильном порядке
- Кэширование статической геометрии
- Оптимизация через Texture Batching

**Оптимизации:**
- Texture Atlas для всех текстур блоков
- Instanced rendering для одинаковых блоков
- Чанки компилируются в статические меши
- Только видимые грани добавляются в батч

#### Грани блоков

```
┌─────────────────────────────────────────────────────────┐
│                VISIBLE FACES CALCULATION                │
│                                                         │
│  Верхняя грань (Top):                                   │
│    Видна ВСЕГДА (кроме Air блоков)                      │
│                                                         │
│  Южная грань (South/Front):                             │
│    Видна если блок южнее - Air или ниже по Z            │
│                                                         │
│  Восточная грань (East/Right):                          │
│    Видна если блок восточнее - Air или ниже по Z        │
│                                                         │
│  Северная и Западная грани:                             │
│    Обычно НЕ видны (закрыты другими блоками)            │
│    Могут быть видны на краях карты                      │
└─────────────────────────────────────────────────────────┘
```

### 5.3 Рендеринг сущностей

#### Сортировка по глубине (Z-Sorting)

```
┌─────────────────────────────────────────────────────────┐
│                  DEPTH SORTING                          │
│                                                         │
│  Depth = Y + (Z × MAP_HEIGHT) + (spriteHeight / 2)      │
│                                                         │
│  Пример:                                                │
│  - Машина на земле (Y=100, Z=0): depth = 100            │
│  - Пешеход на мосту (Y=100, Z=3): depth = 100 + 768     │
│  - Машина за пешеходом (Y=110, Z=3): depth = 110 + 768  │
│                                                         │
│  Сортировка: от меньшего depth к большему               │
└─────────────────────────────────────────────────────────┘
```

#### Класс EntityRenderer

**Ответственность:**
- Сбор всех видимых сущностей
- Сортировка по глубине
- Применение правильных спрайтов (угол поворота)
- Анимация спрайтов

### 5.4 Спрайтовая система

#### Структура спрайтов транспорта

```
┌─────────────────────────────────────────────────────────┐
│              VEHICLE SPRITE SHEET                       │
│                                                         │
│  32 угла поворота (каждые 11.25°):                      │
│                                                         │
│  ┌───┬───┬───┬───┬───┬───┬───┬───┐                     │
│  │ 0°│11°│22°│34°│45°│56°│67°│79°│  ... (32 кадра)     │
│  └───┴───┴───┴───┴───┴───┴───┴───┘                     │
│                                                         │
│  Дополнительные состояния:                              │
│  - Нормальное                                           │
│  - Повреждённое (3 уровня)                              │
│  - Горящее                                              │
│  - Взорванное                                           │
│                                                         │
│  Итого: 32 × 6 = 192 кадра на машину                    │
└─────────────────────────────────────────────────────────┘
```

#### Структура спрайтов персонажей

```
┌─────────────────────────────────────────────────────────┐
│             PEDESTRIAN SPRITE SHEET                     │
│                                                         │
│  8 направлений:                                         │
│       N                                                 │
│    NW   NE                                              │
│  W    ●    E                                            │
│    SW   SE                                              │
│       S                                                 │
│                                                         │
│  Анимации (кадры на направление):                       │
│  - Idle: 1-4 кадра                                      │
│  - Walk: 8 кадров                                       │
│  - Run: 8 кадров                                        │
│  - Attack: 4-8 кадров                                   │
│  - Death: 4-8 кадров                                    │
│                                                         │
│  Итого: 8 × ~30 = ~240 кадров на персонажа              │
└─────────────────────────────────────────────────────────┘
```

### 5.5 Камера

#### Класс Camera

**Свойства:**
- position (x, y) — мировые координаты центра
- targetPosition — точка, к которой движется камера
- zoom — масштаб (1.0 = 100%)
- bounds — ограничения движения
- shakeIntensity — интенсивность тряски

**Режимы следования:**
- Follow Player — следует за игроком с лагом
- Fixed — статичная камера
- Cinematic — движение по сплайну

**Методы:**
- `follow(entity, smoothing)` — следовать за сущностью
- `shake(intensity, duration)` — тряска камеры
- `worldToScreen(x, y, z)` — мировые в экранные
- `screenToWorld(screenX, screenY)` — экранные в мировые
- `isVisible(bounds)` — проверка видимости

---

## 6. Система сущностей (ECS)

### 6.1 Архитектура ECS

```
┌─────────────────────────────────────────────────────────┐
│                    ECS ARCHITECTURE                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ENTITY (просто ID)                                     │
│  ┌─────────────────────────────────────────────────┐    │
│  │  Entity #42                                     │    │
│  │  - Просто число (uint32)                        │    │
│  │  - Нет данных, нет логики                       │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  COMPONENTS (только данные)                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │
│  │Position  │ │Velocity  │ │ Sprite   │ │ Health   │   │
│  │ x: f32   │ │ vx: f32  │ │ id: u16  │ │ hp: u16  │   │
│  │ y: f32   │ │ vy: f32  │ │frame:u8  │ │max: u16  │   │
│  │ z: f32   │ │ vz: f32  │ │         │ │          │   │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │
│                                                         │
│  SYSTEMS (только логика)                                │
│  ┌─────────────────────────────────────────────────┐    │
│  │  MovementSystem                                 │    │
│  │  - Query: [Position, Velocity]                  │    │
│  │  - Logic: position += velocity × dt             │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 6.2 Компоненты

#### Базовые компоненты

| Компонент | Поля | Описание |
|-----------|------|----------|
| **Position** | x, y, z | Позиция в мире |
| **Velocity** | vx, vy, vz | Скорость движения |
| **Rotation** | angle | Угол поворота (радианы) |
| **Scale** | sx, sy | Масштаб |
| **Sprite** | textureId, frame, anchor | Визуальное представление |
| **Collider** | type, width, height, offsetX, offsetY | Коллайдер |
| **Health** | current, max | Здоровье |
| **Team** | teamId | Принадлежность к команде |

#### Компоненты транспорта

| Компонент | Поля | Описание |
|-----------|------|----------|
| **Vehicle** | type, damage, fuel | Тип и состояние машины |
| **VehiclePhysics** | acceleration, maxSpeed, handling, grip, mass | Физические параметры |
| **VehicleDriver** | driverEntity, passengers[] | Водитель и пассажиры |
| **VehicleAI** | mode, targetPath, aggression | AI поведение |

#### Компоненты персонажей

| Компонент | Поля | Описание |
|-----------|------|----------|
| **Pedestrian** | type, mood, walkSpeed | Тип пешехода |
| **PedestrianAI** | state, targetPosition, fear | AI состояние |
| **Inventory** | weapons[], currentWeapon, ammo | Инвентарь |
| **PlayerControlled** | — (tag) | Флаг игрока |

#### Компоненты оружия и эффектов

| Компонент | Поля | Описание |
|-----------|------|----------|
| **Weapon** | type, damage, fireRate, range | Параметры оружия |
| **Projectile** | damage, speed, owner | Пуля/снаряд |
| **Explosion** | radius, damage, timer | Взрыв |
| **Particle** | lifetime, color, size | Частица |

### 6.3 Системы

#### Порядок выполнения систем

```
┌─────────────────────────────────────────────────────────┐
│              SYSTEMS EXECUTION ORDER                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. INPUT SYSTEMS                                       │
│     └─► PlayerInputSystem                               │
│                                                         │
│  2. AI SYSTEMS                                          │
│     ├─► PedestrianAISystem                              │
│     ├─► VehicleAISystem                                 │
│     └─► PoliceAISystem                                  │
│                                                         │
│  3. GAMEPLAY SYSTEMS                                    │
│     ├─► WeaponSystem                                    │
│     ├─► ProjectileSystem                                │
│     └─► ExplosionSystem                                 │
│                                                         │
│  4. PHYSICS SYSTEMS                                     │
│     ├─► VehiclePhysicsSystem                            │
│     ├─► MovementSystem                                  │
│     └─► CollisionSystem                                 │
│                                                         │
│  5. STATE SYSTEMS                                       │
│     ├─► HealthSystem                                    │
│     ├─► DeathSystem                                     │
│     └─► SpawnSystem                                     │
│                                                         │
│  6. ANIMATION SYSTEMS                                   │
│     ├─► SpriteAnimationSystem                           │
│     └─► ParticleSystem                                  │
│                                                         │
│  7. RENDER SYSTEMS                                      │
│     └─► SpriteRenderSystem                              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### Описание ключевых систем

**PlayerInputSystem**
- Query: [PlayerControlled, Position, Velocity] или [PlayerControlled, VehicleDriver]
- Считывает ввод и применяет к игроку
- Обрабатывает вход/выход из машины

**VehiclePhysicsSystem**
- Query: [Vehicle, VehiclePhysics, Position, Velocity, Rotation]
- Применяет физику машин: ускорение, торможение, поворот, дрифт
- Учитывает тип поверхности

**MovementSystem**
- Query: [Position, Velocity]
- Применяет скорость к позиции
- Учитывает Z-уровень и slopes

**CollisionSystem**
- Query: [Position, Collider]
- Проверяет коллизии между сущностями
- Проверяет коллизии с картой

**PedestrianAISystem**
- Query: [Pedestrian, PedestrianAI, Position]
- Управляет поведением пешеходов
- Реакция на опасность, поиск пути

**HealthSystem**
- Query: [Health]
- Обрабатывает урон и лечение
- Триггерит смерть при hp <= 0

### 6.4 Архетипы сущностей

#### Предопределённые конфигурации

```
┌─────────────────────────────────────────────────────────┐
│                     ARCHETYPES                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  PLAYER                                                 │
│  └─► Position + Velocity + Rotation + Sprite +          │
│      Collider + Health + Inventory + PlayerControlled   │
│                                                         │
│  PEDESTRIAN                                             │
│  └─► Position + Velocity + Rotation + Sprite +          │
│      Collider + Health + Pedestrian + PedestrianAI      │
│                                                         │
│  VEHICLE                                                │
│  └─► Position + Velocity + Rotation + Sprite +          │
│      Collider + Health + Vehicle + VehiclePhysics       │
│                                                         │
│  PROJECTILE                                             │
│  └─► Position + Velocity + Sprite + Projectile          │
│                                                         │
│  PICKUP                                                 │
│  └─► Position + Sprite + Collider + Pickup              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 7. Физический движок

### 7.1 Интеграция Matter.js

```
┌─────────────────────────────────────────────────────────┐
│               PHYSICS ARCHITECTURE                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │              PhysicsManager                     │    │
│  │  ┌─────────────────────────────────────────┐   │    │
│  │  │          Matter.js Engine               │   │    │
│  │  │  ┌───────────────────────────────────┐  │   │    │
│  │  │  │            World                  │  │   │    │
│  │  │  │  - Gravity (0, 0) — вид сверху   │  │   │    │
│  │  │  │  - Bodies[]                       │  │   │    │
│  │  │  │  - Constraints[]                  │  │   │    │
│  │  │  └───────────────────────────────────┘  │   │    │
│  │  └─────────────────────────────────────────┘   │    │
│  │                                                │    │
│  │  Sync: ECS Position ◄──► Matter.js Body        │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 7.2 Физика транспорта

#### Модель движения

```
┌─────────────────────────────────────────────────────────┐
│              VEHICLE PHYSICS MODEL                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  FORCES:                                                │
│  ┌─────────────────────────────────────────────────┐    │
│  │                   Drag                          │    │
│  │                     ▲                           │    │
│  │                     │                           │    │
│  │  Lateral ◄──────────┼──────────► Thrust         │    │
│  │  Friction           │           (Engine)        │    │
│  │                     │                           │    │
│  │                     ▼                           │    │
│  │                  Weight                         │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  PARAMETERS:                                            │
│  - mass: Влияет на инерцию и ускорение                 │
│  - grip: Сцепление с дорогой (0.0 - 1.0)               │
│  - handling: Скорость поворота                          │
│  - acceleration: Мощность двигателя                     │
│  - maxSpeed: Максимальная скорость                      │
│  - braking: Сила торможения                             │
│                                                         │
│  DRIFT MECHANICS:                                       │
│  - При высокой скорости поворота: grip снижается        │
│  - Задняя ось скользит больше передней                  │
│  - E-brake: grip = 0, максимальный занос                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### Типы транспорта

| Тип | Mass | Grip | Handling | MaxSpeed | Особенности |
|-----|------|------|----------|----------|-------------|
| Sports Car | Low | High | High | Very High | Лёгкий дрифт |
| Truck | High | Medium | Low | Medium | Тяжёлый, мощный |
| Taxi | Medium | Medium | Medium | Medium | Сбалансирован |
| Police | Medium | High | High | High | Быстрый, устойчивый |
| Bus | Very High | Low | Very Low | Low | Неповоротливый |
| Motorcycle | Very Low | High | Very High | High | Быстрый, хрупкий |

### 7.3 Типы поверхностей

```
┌─────────────────────────────────────────────────────────┐
│                 SURFACE TYPES                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌────────────┬────────┬──────────┬──────────────────┐  │
│  │ Surface    │ Grip   │ Speed    │ Effect           │  │
│  ├────────────┼────────┼──────────┼──────────────────┤  │
│  │ Road       │ 1.0    │ 1.0      │ Normal           │  │
│  │ Grass      │ 0.7    │ 0.6      │ Slowdown         │  │
│  │ Dirt       │ 0.6    │ 0.7      │ Dust particles   │  │
│  │ Ice        │ 0.2    │ 1.0      │ Sliding          │  │
│  │ Oil        │ 0.1    │ 1.0      │ No control       │  │
│  │ Water      │ 0.5    │ 0.3      │ Splashes, damage │  │
│  │ Sand       │ 0.5    │ 0.5      │ Heavy slowdown   │  │
│  └────────────┴────────┴──────────┴──────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 7.4 Коллизии

#### Слои коллизий

```
┌─────────────────────────────────────────────────────────┐
│               COLLISION LAYERS                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Layer Bits:                                            │
│  ┌─────────────────────────────────────────────────┐    │
│  │  Bit 0: STATIC     (walls, buildings)           │    │
│  │  Bit 1: VEHICLE    (cars, trucks)               │    │
│  │  Bit 2: PEDESTRIAN (people)                     │    │
│  │  Bit 3: PROJECTILE (bullets, rockets)           │    │
│  │  Bit 4: PICKUP     (weapons, health)            │    │
│  │  Bit 5: TRIGGER    (mission triggers)           │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  Collision Matrix:                                      │
│  ┌─────────┬───┬───┬───┬───┬───┬───┐                   │
│  │         │STA│VEH│PED│PRO│PIC│TRI│                   │
│  ├─────────┼───┼───┼───┼───┼───┼───┤                   │
│  │ STATIC  │ - │ ✓ │ ✓ │ ✓ │ - │ - │                   │
│  │ VEHICLE │ ✓ │ ✓ │ ✓ │ ✓ │ ✓ │ ✓ │                   │
│  │ PEDEST. │ ✓ │ ✓ │ ✓ │ ✓ │ ✓ │ ✓ │                   │
│  │ PROJECT.│ ✓ │ ✓ │ ✓ │ - │ - │ - │                   │
│  │ PICKUP  │ - │ ✓ │ ✓ │ - │ - │ - │                   │
│  │ TRIGGER │ - │ ✓ │ ✓ │ - │ - │ - │                   │
│  └─────────┴───┴───┴───┴───┴───┴───┘                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### Обработка столкновений

**Класс CollisionHandler**

Обрабатывает события:
- `onVehicleHitVehicle(a, b, impulse)` — столкновение машин
- `onVehicleHitPedestrian(vehicle, ped, speed)` — наезд
- `onVehicleHitWall(vehicle, wall, impulse)` — удар о стену
- `onProjectileHit(projectile, target)` — попадание пули
- `onPickupCollected(entity, pickup)` — подбор предмета

---

## 8. Система ввода

### 8.1 Архитектура ввода

```
┌─────────────────────────────────────────────────────────┐
│                  INPUT ARCHITECTURE                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │  Keyboard   │  │    Mouse    │  │   Gamepad   │     │
│  │   Events    │  │   Events    │  │   Events    │     │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘     │
│         │                │                │             │
│         ▼                ▼                ▼             │
│  ┌─────────────────────────────────────────────────┐   │
│  │              InputManager                       │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │           Input State                    │   │   │
│  │  │  - keysDown: Set<string>                │   │   │
│  │  │  - keysJustPressed: Set<string>         │   │   │
│  │  │  - mousePosition: {x, y}                │   │   │
│  │  │  - mouseButtons: number                 │   │   │
│  │  │  - gamepadState: GamepadState           │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └──────────────────────┬──────────────────────────┘   │
│                         │                               │
│                         ▼                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Action Mapper                      │   │
│  │  - Maps raw input to game actions              │   │
│  │  - Supports rebinding                          │   │
│  │  - Handles input conflicts                     │   │
│  └──────────────────────┬──────────────────────────┘   │
│                         │                               │
│                         ▼                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Game Actions                       │   │
│  │  - moveForward, moveBackward                   │   │
│  │  - turnLeft, turnRight                         │   │
│  │  - accelerate, brake, handbrake                │   │
│  │  - fire, enterVehicle, nextWeapon              │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 8.2 Игровые действия

#### Действия пешехода

| Action | Default Key | Gamepad | Description |
|--------|-------------|---------|-------------|
| moveUp | W | Left Stick Up | Движение вверх |
| moveDown | S | Left Stick Down | Движение вниз |
| moveLeft | A | Left Stick Left | Движение влево |
| moveRight | D | Left Stick Right | Движение вправо |
| run | Shift | A Button | Бег |
| fire | LMB / Ctrl | Right Trigger | Стрельба |
| enterVehicle | E / Enter | Y Button | Вход в машину |
| nextWeapon | Mouse Wheel | D-Pad Right | Следующее оружие |
| prevWeapon | Mouse Wheel | D-Pad Left | Предыдущее оружие |

#### Действия водителя

| Action | Default Key | Gamepad | Description |
|--------|-------------|---------|-------------|
| accelerate | W / Up | Right Trigger | Газ |
| brake | S / Down | Left Trigger | Тормоз |
| steerLeft | A / Left | Left Stick | Поворот влево |
| steerRight | D / Right | Left Stick | Поворот вправо |
| handbrake | Space | A Button | Ручной тормоз |
| horn | H | Left Stick Press | Сигнал |
| exitVehicle | E / Enter | Y Button | Выход из машины |

---

## 9. Искусственный интеллект

### 9.1 Архитектура AI

```
┌─────────────────────────────────────────────────────────┐
│                   AI ARCHITECTURE                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │                 AIManager                       │    │
│  │  - Manages all AI entities                      │    │
│  │  - Distributes processing across frames         │    │
│  │  - LOD system for distant AI                    │    │
│  └─────────────────────────────────────────────────┘    │
│                         │                               │
│         ┌───────────────┼───────────────┐               │
│         ▼               ▼               ▼               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │
│  │ Pedestrian  │ │  Traffic    │ │   Police    │       │
│  │    AI       │ │    AI       │ │    AI       │       │
│  └─────────────┘ └─────────────┘ └─────────────┘       │
│                                                         │
│  SHARED SYSTEMS:                                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │
│  │ Pathfinding │ │  Steering   │ │  Behavior   │       │
│  │   (A*)      │ │ Behaviors   │ │   Trees     │       │
│  └─────────────┘ └─────────────┘ └─────────────┘       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 9.2 AI пешеходов

#### Состояния пешехода (FSM)

```
┌─────────────────────────────────────────────────────────┐
│              PEDESTRIAN STATE MACHINE                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│                    ┌──────────┐                         │
│                    │   IDLE   │                         │
│                    └────┬─────┘                         │
│                         │ destination set               │
│                         ▼                               │
│                    ┌──────────┐                         │
│          ┌────────►│ WALKING  │◄────────┐               │
│          │         └────┬─────┘         │               │
│          │              │               │               │
│   arrived│              │danger nearby  │ safe          │
│          │              ▼               │               │
│          │         ┌──────────┐         │               │
│          │         │ FLEEING  ├─────────┘               │
│          │         └────┬─────┘                         │
│          │              │                               │
│          │              │ caught / hit                  │
│          │              ▼                               │
│          │         ┌──────────┐                         │
│          └─────────┤  DEAD    │                         │
│                    └──────────┘                         │
│                                                         │
│  Additional states: ENTERING_VEHICLE, RUNNING,         │
│                     ATTACKING, COWERING                 │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### Поведение пешеходов

| Поведение | Триггер | Действие |
|-----------|---------|----------|
| Патрулирование | По умолчанию | Движение между waypoints |
| Побег | Взрыв, выстрелы рядом | Бег от источника опасности |
| Паника | Много опасности | Хаотичный бег |
| Вход в машину | Видит свою машину | Идёт к машине, садится |
| Агрессия | Банда, угроза | Атакует игрока |

### 9.3 AI трафика

#### Состояния машины трафика

```
┌─────────────────────────────────────────────────────────┐
│               TRAFFIC STATE MACHINE                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│         ┌──────────┐                                    │
│         │ DRIVING  │◄───────────────────┐               │
│         └────┬─────┘                    │               │
│              │                          │               │
│   ┌──────────┼──────────┐               │               │
│   │          │          │               │               │
│   ▼          ▼          ▼               │               │
│ ┌────┐  ┌────────┐  ┌────────┐         │               │
│ │STOP│  │WAITING │  │TURNING │         │               │
│ │SIGN│  │ LIGHT  │  │        │         │               │
│ └──┬─┘  └───┬────┘  └───┬────┘         │               │
│    │        │           │               │               │
│    └────────┴───────────┴───────────────┘               │
│                                                         │
│  Emergency states: EVADING, CRASHED, FLEEING            │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### Система дорожного движения

**Компоненты:**
- Waypoints — точки маршрута
- Lanes — полосы движения
- Intersections — перекрёстки
- Traffic Lights — светофоры

**Поведение:**
- Следование по lane spline
- Остановка на красный свет
- Уступание при поворотах
- Объезд препятствий
- Реакция на аварии

### 9.4 AI полиции

#### Уровни розыска (Wanted Level)

```
┌─────────────────────────────────────────────────────────┐
│                 WANTED LEVEL SYSTEM                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ★☆☆☆☆☆  Level 1: Патрульные ищут игрока               │
│  ★★☆☆☆☆  Level 2: Патрульные преследуют                │
│  ★★★☆☆☆  Level 3: Добавляются машины без сирен         │
│  ★★★★☆☆  Level 4: Добавляется SWAT                      │
│  ★★★★★☆  Level 5: Добавляется FBI                       │
│  ★★★★★★  Level 6: Армия (танки, вертолёты)             │
│                                                         │
│  Decay: -1 звезда каждые 60 сек вне поля зрения        │
│  Increase: +1 звезда за убийство копа                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### Поведение полиции

**PursuitAI:**
- Pathfinding к последней известной позиции
- Предсказание движения игрока
- Координация между юнитами
- Блокирование путей отхода

**SearchAI:**
- Поиск в последней известной зоне
- Патрулирование периметра
- Случайные проверки

### 9.5 Поиск пути

#### Navigation Mesh / Grid

```
┌─────────────────────────────────────────────────────────┐
│                  PATHFINDING                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Для пешеходов: Grid-based A*                           │
│  ┌─────────────────────────────────────────────────┐    │
│  │  □ □ □ ■ ■ □ □ □ □ □                           │    │
│  │  □ □ □ ■ ■ □ □ □ □ □                           │    │
│  │  S → → ■ ■ → → → → E   S = Start, E = End      │    │
│  │  □ □ ↓ ■ ■ ↑ □ □ □ □   ■ = Obstacle            │    │
│  │  □ □ → → → ↑ □ □ □ □                           │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  Для машин: Waypoint Graph                              │
│  ┌─────────────────────────────────────────────────┐    │
│  │       ●───────●───────●                         │    │
│  │      /         \       \                        │    │
│  │     ●           ●───────●                       │    │
│  │      \         /       /                        │    │
│  │       ●───────●───────●                         │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  Оптимизации:                                           │
│  - Hierarchical pathfinding (HPA*)                      │
│  - Path caching                                         │
│  - Partial path recalculation                           │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 10. Аудио система

### 10.1 Архитектура аудио

```
┌─────────────────────────────────────────────────────────┐
│                 AUDIO ARCHITECTURE                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │               AudioManager                      │    │
│  │  - Master volume control                        │    │
│  │  - Category volumes (SFX, Music, Ambient)       │    │
│  │  - Audio pools for frequent sounds              │    │
│  └─────────────────────────────────────────────────┘    │
│                         │                               │
│         ┌───────────────┼───────────────┐               │
│         ▼               ▼               ▼               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │
│  │   Music     │ │    SFX      │ │  Ambient    │       │
│  │   System    │ │   System    │ │   System    │       │
│  │             │ │             │ │             │       │
│  │ - Tracks    │ │ - One-shot  │ │ - Loops     │       │
│  │ - Crossfade │ │ - Positional│ │ - Zone-based│       │
│  │ - Radio     │ │ - Pooled    │ │ - Layered   │       │
│  └─────────────┘ └─────────────┘ └─────────────┘       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 10.2 Категории звуков

#### Sound Effects (SFX)

| Категория | Примеры | Особенности |
|-----------|---------|-------------|
| **Weapons** | Выстрелы, перезарядка | Позиционные |
| **Vehicles** | Двигатель, скрип, гудок | Зависят от скорости |
| **Impacts** | Удары, взрывы | Вариации pitch |
| **Footsteps** | Шаги по разным поверхностям | Зависят от материала |
| **UI** | Клики, уведомления | Не позиционные |

#### Музыка

**Radio System (как в GTA):**
- Несколько радиостанций
- Каждая со своим плейлистом
- Переключение при смене станции
- Fade при выходе из машины

#### Ambient

**Zone-based Ambient:**
- Downtown: трафик, толпы, сирены
- Industrial: машины, гудки, лязг
- Suburbs: птицы, собаки, дети

### 10.3 Позиционный звук

```
┌─────────────────────────────────────────────────────────┐
│              POSITIONAL AUDIO                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Параметры:                                             │
│  - Distance attenuation (затухание с расстоянием)       │
│  - Stereo panning (панорама лево-право)                 │
│  - Doppler effect (для быстро движущихся объектов)      │
│                                                         │
│  Формулы:                                               │
│  volume = baseVolume × (1 - distance / maxDistance)     │
│  pan = clamp((sourceX - listenerX) / panRange, -1, 1)   │
│                                                         │
│                    Listener (Camera)                    │
│                          ●                              │
│                         /│\                             │
│                        / │ \                            │
│                       /  │  \  Hearing radius           │
│                      /   │   \                          │
│                     ●    ●    ●  Sound sources          │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 11. Управление ресурсами

### 11.1 Архитектура загрузки

```
┌─────────────────────────────────────────────────────────┐
│               ASSET MANAGEMENT                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │              AssetManager                       │    │
│  │  - Async loading queue                          │    │
│  │  - Progress tracking                            │    │
│  │  - Reference counting                           │    │
│  │  - Memory budgets                               │    │
│  └─────────────────────────────────────────────────┘    │
│                         │                               │
│         ┌───────────────┼───────────────┐               │
│         ▼               ▼               ▼               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │
│  │  Textures   │ │   Audio     │ │    Data     │       │
│  │   Loader    │ │   Loader    │ │   Loader    │       │
│  │             │ │             │ │             │       │
│  │ - Atlases   │ │ - Music     │ │ - Maps      │       │
│  │ - Sprites   │ │ - SFX       │ │ - Configs   │       │
│  └─────────────┘ └─────────────┘ └─────────────┘       │
│                                                         │
│  LOADING PHASES:                                        │
│  1. Boot (minimal UI assets)                            │
│  2. Menu (UI, music)                                    │
│  3. Level (map, entities, sounds)                       │
│  4. Streaming (distant chunks)                          │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 11.2 Texture Atlases

#### Структура атласов

```
┌─────────────────────────────────────────────────────────┐
│                 TEXTURE ATLASES                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  blocks.png (2048×2048)                                 │
│  ┌─────────────────────────────────────────────────┐    │
│  │ ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐      │    │
│  │ │   │   │   │   │   │   │   │   │   │   │      │    │
│  │ ├───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤      │    │
│  │ │   │   │   │   │   │   │   │   │   │   │ ...  │    │
│  │ └───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘      │    │
│  │  64×64 tiles × 32×32 = 1024 block textures     │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
│  vehicles.png (2048×2048)                               │
│  - All vehicle sprites (32 angles × ~20 vehicles)       │
│                                                         │
│  pedestrians.png (2048×2048)                            │
│  - All pedestrian sprites (8 dirs × animations)         │
│                                                         │
│  effects.png (1024×1024)                                │
│  - Particles, explosions, muzzle flashes                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 11.3 Форматы данных

#### Map Format (.json)

```json
{
  "version": "1.0",
  "name": "Downtown",
  "size": { "width": 256, "height": 256, "depth": 8 },
  "chunks": [
    {
      "x": 0, "y": 0,
      "blocks": "base64_encoded_block_data",
      "staticEntities": [...]
    }
  ],
  "districts": [...],
  "spawnPoints": [...],
  "waypoints": [...]
}
```

#### Entity Definitions (.json)

```json
{
  "vehicles": {
    "taxi": {
      "sprite": "vehicles/taxi",
      "physics": {
        "mass": 1200,
        "maxSpeed": 180,
        "acceleration": 80,
        "handling": 0.8,
        "grip": 0.9
      },
      "health": 100,
      "seats": 4
    }
  }
}
```

---

## 12. Структура проекта

### 12.1 Файловая структура

```
gta2-clone/
├── public/
│   ├── index.html
│   └── favicon.ico
├── assets/
│   ├── textures/
│   │   ├── blocks/
│   │   │   ├── roads.png
│   │   │   ├── buildings.png
│   │   │   └── terrain.png
│   │   ├── vehicles/
│   │   │   ├── cars.png
│   │   │   └── trucks.png
│   │   ├── pedestrians/
│   │   │   ├── civilians.png
│   │   │   └── gangs.png
│   │   ├── effects/
│   │   │   ├── particles.png
│   │   │   └── explosions.png
│   │   └── ui/
│   │       ├── hud.png
│   │       └── menu.png
│   ├── audio/
│   │   ├── music/
│   │   ├── sfx/
│   │   └── ambient/
│   ├── maps/
│   │   ├── downtown.json
│   │   └── industrial.json
│   └── data/
│       ├── vehicles.json
│       ├── weapons.json
│       └── pedestrians.json
├── src/
│   ├── main.ts                    # Entry point
│   ├── Game.ts                    # Main game class
│   │
│   ├── core/
│   │   ├── Engine.ts              # Game loop, timing
│   │   ├── EventBus.ts            # Event system
│   │   ├── ServiceLocator.ts      # Dependency injection
│   │   └── Types.ts               # Core type definitions
│   │
│   ├── world/
│   │   ├── GameMap.ts             # Map container
│   │   ├── Chunk.ts               # 16×16×8 block chunk
│   │   ├── Block.ts               # Block definitions
│   │   ├── BlockRegistry.ts       # Block type registry
│   │   ├── District.ts            # City districts
│   │   └── SpatialHash.ts         # Spatial indexing
│   │
│   ├── ecs/
│   │   ├── World.ts               # ECS world (bitECS)
│   │   ├── components/
│   │   │   ├── Transform.ts       # Position, rotation, scale
│   │   │   ├── Physics.ts         # Velocity, collider
│   │   │   ├── Sprite.ts          # Visual representation
│   │   │   ├── Health.ts          # HP system
│   │   │   ├── Vehicle.ts         # Vehicle data
│   │   │   ├── Pedestrian.ts      # Pedestrian data
│   │   │   ├── AI.ts              # AI state
│   │   │   └── Player.ts          # Player tag
│   │   ├── systems/
│   │   │   ├── MovementSystem.ts
│   │   │   ├── VehiclePhysicsSystem.ts
│   │   │   ├── CollisionSystem.ts
│   │   │   ├── PedestrianAISystem.ts
│   │   │   ├── TrafficAISystem.ts
│   │   │   ├── PoliceAISystem.ts
│   │   │   ├── WeaponSystem.ts
│   │   │   ├── HealthSystem.ts
│   │   │   ├── AnimationSystem.ts
│   │   │   └── RenderSystem.ts
│   │   └── archetypes/
│   │       ├── PlayerArchetype.ts
│   │       ├── VehicleArchetype.ts
│   │       └── PedestrianArchetype.ts
│   │
│   ├── rendering/
│   │   ├── Renderer.ts            # Main renderer
│   │   ├── Camera.ts              # 2.5D camera
│   │   ├── MapRenderer.ts         # Block rendering
│   │   ├── EntityRenderer.ts      # Sprite rendering
│   │   ├── EffectsRenderer.ts     # Particles, etc
│   │   ├── UIRenderer.ts          # HUD, menus
│   │   └── DepthSorter.ts         # Z-sorting
│   │
│   ├── physics/
│   │   ├── PhysicsManager.ts      # Matter.js wrapper
│   │   ├── VehiclePhysics.ts      # Car physics model
│   │   ├── CollisionHandler.ts    # Collision responses
│   │   └── SurfaceTypes.ts        # Surface definitions
│   │
│   ├── input/
│   │   ├── InputManager.ts        # Input handling
│   │   ├── ActionMapper.ts        # Key bindings
│   │   └── GamepadHandler.ts      # Gamepad support
│   │
│   ├── ai/
│   │   ├── AIManager.ts           # AI coordination
│   │   ├── Pathfinding.ts         # A* implementation
│   │   ├── SteeringBehaviors.ts   # Seek, flee, etc
│   │   ├── PedestrianBrain.ts     # Pedestrian AI
│   │   ├── TrafficBrain.ts        # Traffic AI
│   │   └── PoliceBrain.ts         # Police AI
│   │
│   ├── audio/
│   │   ├── AudioManager.ts        # Howler.js wrapper
│   │   ├── MusicPlayer.ts         # Radio system
│   │   ├── SoundEffects.ts        # SFX playback
│   │   └── AmbientManager.ts      # Ambient sounds
│   │
│   ├── assets/
│   │   ├── AssetManager.ts        # Asset loading
│   │   ├── TextureLoader.ts       # Texture loading
│   │   ├── AudioLoader.ts         # Audio loading
│   │   └── MapLoader.ts           # Map parsing
│   │
│   ├── gameplay/
│   │   ├── Player.ts              # Player controller
│   │   ├── WantedSystem.ts        # Police wanted level
│   │   ├── WeaponManager.ts       # Weapon handling
│   │   ├── VehicleManager.ts      # Vehicle spawning
│   │   └── MissionSystem.ts       # Mission logic
│   │
│   ├── ui/
│   │   ├── UIManager.ts           # UI coordination
│   │   ├── HUD.ts                 # In-game HUD
│   │   ├── Minimap.ts             # Minimap
│   │   ├── MainMenu.ts            # Main menu
│   │   └── PauseMenu.ts           # Pause screen
│   │
│   ├── scenes/
│   │   ├── SceneManager.ts        # Scene transitions
│   │   ├── BootScene.ts           # Initial loading
│   │   ├── MenuScene.ts           # Main menu
│   │   ├── GameScene.ts           # Gameplay
│   │   └── LoadingScene.ts        # Level loading
│   │
│   └── utils/
│       ├── Math.ts                # Math utilities
│       ├── Random.ts              # RNG utilities
│       ├── Pool.ts                # Object pooling
│       └── Debug.ts               # Debug utilities
│
├── tools/
│   ├── map-editor/                # Custom map editor
│   └── sprite-packer/             # Atlas generator
│
├── tests/
│   ├── unit/
│   └── integration/
│
├── package.json
├── tsconfig.json
├── vite.config.ts
└── README.md
```

### 12.2 Диаграмма зависимостей

```
┌─────────────────────────────────────────────────────────┐
│               MODULE DEPENDENCIES                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│                      ┌───────┐                          │
│                      │ Game  │                          │
│                      └───┬───┘                          │
│                          │                              │
│    ┌─────────────────────┼─────────────────────┐        │
│    │           │         │         │           │        │
│    ▼           ▼         ▼         ▼           ▼        │
│ ┌──────┐ ┌─────────┐ ┌───────┐ ┌───────┐ ┌─────────┐   │
│ │Engine│ │Renderer │ │ World │ │Physics│ │  Input  │   │
│ └──┬───┘ └────┬────┘ └───┬───┘ └───┬───┘ └────┬────┘   │
│    │          │          │         │          │         │
│    │    ┌─────┴─────┐    │         │          │         │
│    │    ▼           ▼    ▼         ▼          │         │
│    │ ┌─────┐    ┌──────┐ │    ┌────────┐      │         │
│    │ │Pixi │    │Camera│ │    │Matter.js      │         │
│    │ └─────┘    └──────┘ │    └────────┘      │         │
│    │                     │                     │         │
│    └──────────┬──────────┴─────────────────────┘         │
│               │                                          │
│               ▼                                          │
│           ┌───────┐                                      │
│           │  ECS  │ (bitECS)                             │
│           └───────┘                                      │
│               │                                          │
│    ┌──────────┼──────────┐                               │
│    ▼          ▼          ▼                               │
│ ┌──────┐ ┌────────┐ ┌─────────┐                         │
│ │Comps │ │Systems │ │Queries  │                         │
│ └──────┘ └────────┘ └─────────┘                         │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 13. Форматы данных

### 13.1 Map Format (Детально)

```typescript
interface MapData {
  // Метаданные
  version: string;           // "1.0"
  name: string;              // "Downtown"
  author: string;
  
  // Размеры
  size: {
    width: number;           // В блоках (256)
    height: number;          // В блоках (256)
    depth: number;           // Уровни Z (8)
  };
  
  // Чанки (16×16×8 каждый)
  chunks: ChunkData[];
  
  // Зоны
  districts: DistrictData[];
  
  // Навигация
  pedestrianNav: NavGridData;
  vehicleNav: WaypointGraphData;
  
  // Спавн-точки
  playerSpawns: SpawnPoint[];
  vehicleSpawns: VehicleSpawnPoint[];
  pedestrianSpawns: PedestrianSpawnPoint[];
  
  // Триггеры
  triggers: TriggerData[];
  
  // Освещение
  lighting: LightingData;
}

interface ChunkData {
  x: number;                 // Координата чанка
  y: number;
  
  // Блоки: base64(zlib(Uint32Array[16×16×8]))
  blocks: string;
  
  // Статические сущности в чанке
  staticEntities: StaticEntityData[];
}

interface DistrictData {
  id: string;
  name: string;
  bounds: Polygon;           // Границы района
  gang: string | null;       // Контролирующая банда
  ambientTrack: string;      // Ambient звук
  trafficDensity: number;    // 0.0 - 1.0
  pedestrianDensity: number;
  policePresence: number;
  vehicleTypes: string[];    // Какие машины спавнятся
}
```

### 13.2 Entity Definitions

```typescript
interface VehicleDefinition {
  id: string;                // "taxi"
  name: string;              // "Taxi Cab"
  
  // Визуал
  sprite: {
    atlas: string;           // "vehicles"
    base: string;            // "taxi"
    damageFrames: number;    // 3
  };
  
  // Физика
  physics: {
    mass: number;            // kg
    maxSpeed: number;        // units/sec
    acceleration: number;    // units/sec²
    braking: number;         // units/sec²
    handling: number;        // 0.0 - 1.0
    grip: number;            // 0.0 - 1.0
  };
  
  // Коллайдер
  collider: {
    width: number;
    height: number;
    offsetX: number;
    offsetY: number;
  };
  
  // Геймплей
  health: number;
  seats: number;
  canExplode: boolean;
  explosionRadius: number;
  
  // Звуки
  sounds: {
    engine: string;
    horn: string;
    crash: string;
  };
}

interface WeaponDefinition {
  id: string;
  name: string;
  type: 'melee' | 'pistol' | 'automatic' | 'shotgun' | 'explosive';
  
  damage: number;
  fireRate: number;          // shots/sec
  range: number;
  spread: number;            // degrees
  ammoPerClip: number;
  reloadTime: number;        // seconds
  
  projectile: {
    speed: number;
    sprite: string;
    trail: boolean;
  };
  
  sounds: {
    fire: string;
    reload: string;
    empty: string;
  };
}
```

---

## 14. Оптимизации

### 14.1 Рендеринг

```
┌─────────────────────────────────────────────────────────┐
│            RENDERING OPTIMIZATIONS                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. FRUSTUM CULLING                                     │
│     - Отсечение невидимых чанков                        │
│     - Отсечение невидимых сущностей                     │
│     - Иерархический culling (chunk → entity)            │
│                                                         │
│  2. BATCHING                                            │
│     - Texture atlas для всех блоков                     │
│     - Sprite batching в PixiJS                          │
│     - Минимизация draw calls                            │
│                                                         │
│  3. STATIC GEOMETRY CACHING                             │
│     - Компиляция статичных чанков                       │
│     - Dirty flag для перестроения                       │
│     - Incremental updates                               │
│                                                         │
│  4. LOD (Level of Detail)                               │
│     - Упрощённые спрайты для дальних объектов           │
│     - Отключение анимации для дальних                   │
│     - Снижение частоты обновления                       │
│                                                         │
│  5. OCCLUSION                                           │
│     - Не рисовать блоки под крышами                     │
│     - Не рисовать скрытые грани                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 14.2 Физика и AI

```
┌─────────────────────────────────────────────────────────┐
│             PHYSICS & AI OPTIMIZATIONS                  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. SPATIAL PARTITIONING                                │
│     - Spatial hash для broad phase                      │
│     - Grid-based collision detection                    │
│                                                         │
│  2. AI DISTRIBUTION                                     │
│     - Распределение AI updates по кадрам               │
│     - Приоритет близким к игроку                        │
│     - Sleeping для дальних AI                           │
│                                                         │
│  3. PATHFINDING                                         │
│     - Hierarchical A* (HPA*)                            │
│     - Path caching                                      │
│     - Async pathfinding (Web Workers)                   │
│                                                         │
│  4. OBJECT POOLING                                      │
│     - Pool для пуль/частиц                              │
│     - Pool для AI state objects                         │
│     - Переиспользование вместо GC                       │
│                                                         │
│  5. FIXED TIMESTEP                                      │
│     - Физика с фиксированным dt                         │
│     - Интерполяция для рендеринга                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 14.3 Память

```
┌─────────────────────────────────────────────────────────┐
│              MEMORY OPTIMIZATIONS                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. STREAMING                                           │
│     - Загрузка только видимых чанков                    │
│     - Выгрузка дальних чанков                           │
│     - Асинхронная загрузка                              │
│                                                         │
│  2. ASSET MANAGEMENT                                    │
│     - Reference counting                                │
│     - Lazy loading                                      │
│     - Memory budgets                                    │
│                                                         │
│  3. DATA STRUCTURES                                     │
│     - TypedArrays вместо обычных массивов               │
│     - Flat arrays для ECS компонентов                   │
│     - Structure of Arrays (SoA)                         │
│                                                         │
│  4. GARBAGE COLLECTION                                  │
│     - Object pooling                                    │
│     - Avoid allocations in hot paths                    │
│     - Pre-allocated buffers                             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 15. План разработки

### 15.1 Этапы разработки

```
┌─────────────────────────────────────────────────────────┐
│              DEVELOPMENT ROADMAP                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  PHASE 1: FOUNDATION (4-6 недель)                       │
│  ├── Настройка проекта (Vite, TypeScript)               │
│  ├── Базовый движок и game loop                         │
│  ├── Загрузка и рендеринг блочной карты                 │
│  ├── Камера с прокруткой                                │
│  ├── Базовый input handling                             │
│  └── Простой спрайт игрока                              │
│                                                         │
│  PHASE 2: CORE MECHANICS (6-8 недель)                   │
│  ├── ECS архитектура (bitECS)                           │
│  ├── Физика транспорта (Matter.js)                      │
│  ├── Коллизии с картой                                  │
│  ├── Вход/выход из машины                               │
│  ├── Многоуровневость (slopes, bridges)                 │
│  └── Базовые звуки                                      │
│                                                         │
│  PHASE 3: AI & WORLD (6-8 недель)                       │
│  ├── AI пешеходов (FSM)                                 │
│  ├── AI трафика                                         │
│  ├── Система районов                                    │
│  ├── Спавн/деспавн сущностей                            │
│  ├── Pathfinding (A*)                                   │
│  └── Позиционный звук                                   │
│                                                         │
│  PHASE 4: COMBAT & POLICE (4-6 недель)                  │
│  ├── Система оружия                                     │
│  ├── Здоровье и урон                                    │
│  ├── AI полиции                                         │
│  ├── Wanted level                                       │
│  ├── Взрывы и частицы                                   │
│  └── Разрушаемость                                      │
│                                                         │
│  PHASE 5: POLISH (4-6 недель)                           │
│  ├── UI и HUD                                           │
│  ├── Minimap                                            │
│  ├── Меню и настройки                                   │
│  ├── Сохранение/загрузка                                │
│  ├── Оптимизация                                        │
│  └── Баги и полировка                                   │
│                                                         │
│  PHASE 6: CONTENT (ongoing)                             │
│  ├── Создание карт                                      │
│  ├── Разнообразие машин                                 │
│  ├── Система миссий                                     │
│  └── Дополнительный контент                             │
│                                                         │
│  TOTAL: ~24-34 недели (6-8 месяцев)                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 15.2 Milestones

| Milestone | Описание | Критерии готовности |
|-----------|----------|---------------------|
| **M1: Prototype** | Базовый движок | Карта рендерится, камера двигается |
| **M2: Movement** | Управление | Игрок ходит, коллизии работают |
| **M3: Driving** | Машины | Можно водить машину с физикой |
| **M4: Living City** | AI | Трафик и пешеходы живут |
| **M5: Action** | Экшен | Стрельба, полиция, wanted |
| **M6: Playable** | Играбельно | Полная игровая петля |
| **M7: Release** | Релиз | Оптимизировано, отполировано |

### 15.3 Риски и митигация

| Риск | Вероятность | Импакт | Митигация |
|------|-------------|--------|-----------|
| Производительность | Высокая | Высокий | Профилирование с первого дня, LOD |
| Сложность физики | Средняя | Средний | Итеративная разработка, MVP |
| Память браузера | Средняя | Высокий | Streaming, lazy loading |
| AI complexity | Высокая | Средний | Простые FSM, постепенное усложнение |

---

## Заключение

Данный документ описывает архитектуру браузерного клона GTA 2. Ключевые технические решения:

1. **ECS-архитектура** через bitECS для гибкости и производительности
2. **Блочная карта** с многоуровневостью через slopes
3. **Чанковая система** для оптимизации рендеринга и памяти
4. **Matter.js** для физики с кастомной моделью машин
5. **PixiJS** для эффективного WebGL рендеринга
6. **Hierarchical FSM** для AI

Проект разбит на фазы с чёткими milestone'ами, что позволяет получать играбельные версии на каждом этапе.
